services:

  # 1. THE DATABASE SERVICE
  db:
    # Use the official PostgreSQL image
    image: postgres:16-alpine
    container_name: ultima_postgres_db
    # Environment variables for PostgreSQL's internal setup
    environment:
      POSTGRES_USER: ${POSTGRES_USER}         # Matches the user you use in your Flask app
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}  # Matches the password you use in your Flask app
      POSTGRES_DB: ${POSTGRES_DB}         # Matches the database name
    # Tell Compose to load variables from .env file
    env_file:
      - .env
    # Store the database files in a named volume so data is saved outside the container
    volumes:
      - postgres_data:/var/lib/postgresql/data/
    # Expose the port (only necessary if you need to connect from your local machine outside Docker)
    ports:
      - "5432:5432"

  # 2. YOUR FLASK APPLICATION SERVICE
  app:
    # Tell Docker to build the image using the Dockerfile in the current directory (the '.')
    build: .
    container_name: ultima_flask_app
    # Run the Gunicorn command defined in your Dockerfile
    command: gunicorn --bind 0.0.0.0:8000 'app:create_app()'
    # Map the container port 8000 to your machine's port 80 (or 5000, etc.)
    ports:
      - "80:8000"
    # Environment variables for your Flask application to connect to the 'db' service
    env_file:
      - ${ENV_FILE:-.env.development} # Also load for the app service
    environment:
      DB_HOST: ${DB_HOST}
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB}
    # Wait for the DB service to be ready before starting the Flask app
      SECRET_KEY: ${SECRET_KEY}
    depends_on:
      - db

# Define the volume used by the database to persist data
volumes:
  postgres_data: